---
/**
 * Dynamic entity page template
 * Handles both person and organization detail pages
 */
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';
import { resolveEntityReferences, getOffersByEntity } from '@/lib/entity-utils';

export async function getStaticPaths() {
	const people = await getCollection('person');
	const orgs = await getCollection('organization');

	return [
		...people.map((p) => ({
			params: { collection: 'person', slug: p.id },
			props: { entry: p, entityType: 'person' as const },
		})),
		...orgs.map((o) => ({
			params: { collection: 'organization', slug: o.id },
			props: { entry: o, entityType: 'organization' as const },
		})),
	];
}

interface Props {
	entry: CollectionEntry<'person'> | CollectionEntry<'organization'>;
	entityType: 'person' | 'organization';
}

const { entry, entityType } = Astro.props;

// Render markdown content
const { Content, headings } = await render(entry);

// Resolve relationships
const memberOf =
	entityType === 'person' && 'memberOf' in entry.data
		? await resolveEntityReferences(entry.data.memberOf || [])
		: [];

const worksFor =
	entityType === 'person' && 'worksFor' in entry.data
		? await resolveEntityReferences(entry.data.worksFor || [])
		: [];

const members =
	entityType === 'organization' && 'member' in entry.data
		? await resolveEntityReferences(entry.data.member || [])
		: [];

const parentOrg =
	entityType === 'organization' && 'parentOrganization' in entry.data && entry.data.parentOrganization
		? await resolveEntityReferences([entry.data.parentOrganization])
		: [];

// Get offers made by this entity
const offers = await getOffersByEntity(entry);

const pageTitle = entry.data.name;
const pageDescription = entry.data.description || `Profile for ${entry.data.name}`;
---

<StarlightPage
	frontmatter={{
		title: pageTitle,
		description: pageDescription,
	}}
	headings={headings}
	hasSidebar={false}
>
	<div class="entity-layout">
		<article class="entity-main">
				<header class="entity-header">
					{entry.data.image && (
						<img
							src={entry.data.image}
							alt={entry.data.name}
							class="entity-image"
						/>
					)}
					<div class="entity-title">
								{entityType === 'person' && 'jobTitle' in entry.data && entry.data.jobTitle && (
							<p class="job-title">{entry.data.jobTitle}</p>
						)}
						{entityType === 'organization' && 'legalName' in entry.data && entry.data.legalName && (
							<p class="legal-name">{entry.data.legalName}</p>
						)}
					</div>
				</header>

				<!-- Main Content -->
				<div class="entity-content">
					<Content />
				</div>
		</article>

		<!-- Relationships Sidebar -->
		<aside class="entity-sidebar">
					{memberOf.length > 0 && (
						<section class="relationship-section">
							<h2>Member Of</h2>
							<ul class="entity-list">
								{memberOf.map((org) => (
									<li>
										{typeof org === 'string' ? (
											<span>{org}</span>
										) : (
											<a href={`/organization/${org.id}`}>{org.data.name}</a>
										)}
									</li>
								))}
							</ul>
						</section>
					)}

					{worksFor.length > 0 && (
						<section class="relationship-section">
							<h2>Works For</h2>
							<ul class="entity-list">
								{worksFor.map((org) => (
									<li>
										{typeof org === 'string' ? (
											<span>{org}</span>
										) : (
											<a href={`/organization/${org.id}`}>{org.data.name}</a>
										)}
									</li>
								))}
							</ul>
						</section>
					)}

					{members.length > 0 && (
						<section class="relationship-section">
							<h2>Members</h2>
							<ul class="entity-list">
								{members.map((member) => (
									<li>
										{typeof member === 'string' ? (
											<span>{member}</span>
										) : (
											<a href={`/${member.collection}/${member.id}`}>
												{member.data.name}
											</a>
										)}
									</li>
								))}
							</ul>
						</section>
					)}

					{parentOrg.length > 0 && (
						<section class="relationship-section">
							<h2>Parent Organization</h2>
							{parentOrg.map((org) => (
								typeof org === 'string' ? (
									<p>{org}</p>
								) : (
									<p><a href={`/organization/${org.id}`}>{org.data.name}</a></p>
								)
							))}
						</section>
					)}

					{offers.length > 0 && (
						<section class="relationship-section">
							<h2>Offers</h2>
							<ul class="entity-list">
								{offers.map((offer) => (
									<li>
										<a href={`/offer/${offer.id}`}>{offer.data.name}</a>
									</li>
								))}
							</ul>
						</section>
					)}

					<!-- Contact & Links -->
					{(entry.data.email || entry.data.url || (entry.data.sameAs && entry.data.sameAs.length > 0)) && (
						<section class="relationship-section">
							<h2>Contact & Links</h2>
							<ul class="contact-list">
								{entry.data.email && (
									<li>
										<a href={`mailto:${entry.data.email}`}>{entry.data.email}</a>
									</li>
								)}
								{entry.data.url && (
									<li>
										<a href={entry.data.url} target="_blank" rel="noopener noreferrer">
											Website ↗
										</a>
									</li>
								)}
								{entry.data.sameAs?.map((link) => (
									<li>
										<a href={link} target="_blank" rel="noopener noreferrer">
											{new URL(link).hostname} ↗
										</a>
									</li>
								))}
							</ul>
						</section>
					)}

					<!-- Web3 Identity -->
					{entityType === 'person' && 'ensName' in entry.data && (entry.data.ensName || entry.data.identifier) && (
						<section class="relationship-section">
							<h2>Web3 Identity</h2>
							<ul class="contact-list">
								{entry.data.ensName && (
									<li>ENS: {entry.data.ensName}</li>
								)}
								{entry.data.identifier && (
									<li class="identifier">
										<code>{entry.data.identifier}</code>
									</li>
								)}
							</ul>
						</section>
					)}
		</aside>
	</div>
</StarlightPage>

<style>
	.entity-layout {
		display: grid;
		grid-template-columns: 1fr 300px;
		gap: 2rem;
		max-width: 1400px;
	}

	.entity-main {
		min-width: 0;
	}

	.entity-header {
		display: flex;
		gap: 2rem;
		align-items: flex-start;
		margin-bottom: 1.5rem;
	}

	.entity-image {
		width: 150px;
		height: 150px;
		object-fit: cover;
		border-radius: 8px;
	}

	.entity-title {
		flex: 1;
	}

	.job-title,
	.legal-name {
		color: var(--sl-color-gray-3);
		font-size: 1.1rem;
		margin: 0.5rem 0 0;
	}

	.entity-sidebar {
		min-width: 0;
	}

	.relationship-section {
		margin-bottom: 1.5rem;
		padding: 1rem;
		background: var(--sl-color-bg-sidebar);
		border: 1px solid var(--sl-color-gray-5);
		border-radius: 8px;
	}

	.relationship-section h2 {
		font-size: 1.1rem;
		margin-top: 0;
		margin-bottom: 0.75rem;
		color: var(--sl-color-text-accent);
	}

	.relationship-section p {
		color: var(--sl-color-gray-3);
	}

	.entity-list,
	.contact-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.entity-list li,
	.contact-list li {
		margin-bottom: 0.5rem;
		color: var(--sl-color-gray-3);
	}

	.entity-list a,
	.contact-list a {
		color: var(--sl-color-text-accent);
		text-decoration: none;
	}

	.entity-list a:hover,
	.contact-list a:hover {
		text-decoration: underline;
	}

	.entity-list span,
	.contact-list span {
		color: var(--sl-color-gray-3);
	}

	.identifier code {
		font-size: 0.75rem;
		word-break: break-all;
		background: var(--sl-color-gray-6);
		color: var(--sl-color-text);
		padding: 0.25rem 0.5rem;
		border-radius: 4px;
	}

	@media (max-width: 1024px) {
		.entity-layout {
			grid-template-columns: 1fr;
		}

		.entity-header {
			flex-direction: column;
		}
	}
</style>
