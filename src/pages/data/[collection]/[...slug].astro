---
/**
 * Dynamic entity page template
 * Handles both person and organization detail pages
 */
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';
import { resolveEntityReferences, getOffersByEntity } from '@/lib/entity-utils';

export async function getStaticPaths() {
	const people = await getCollection('person');
	const orgs = await getCollection('organization');

	return [
		...people.map((p) => ({
			params: { collection: 'person', slug: p.id },
			props: { entry: p, entityType: 'person' as const },
		})),
		...orgs.map((o) => ({
			params: { collection: 'organization', slug: o.id },
			props: { entry: o, entityType: 'organization' as const },
		})),
	];
}

interface Props {
	entry: CollectionEntry<'person'> | CollectionEntry<'organization'>;
	entityType: 'person' | 'organization';
}

const { entry, entityType } = Astro.props;

// Render markdown content
const { Content, headings } = await render(entry);

// Resolve relationships
const memberOf =
	entityType === 'person' && 'memberOf' in entry.data
		? await resolveEntityReferences(entry.data.memberOf || [])
		: [];

const worksFor =
	entityType === 'person' && 'worksFor' in entry.data
		? await resolveEntityReferences(entry.data.worksFor || [])
		: [];

const members =
	entityType === 'organization' && 'member' in entry.data
		? await resolveEntityReferences(entry.data.member || [])
		: [];

const parentOrg =
	entityType === 'organization' && 'parentOrganization' in entry.data && entry.data.parentOrganization
		? await resolveEntityReferences([entry.data.parentOrganization])
		: [];

// Get offers made by this entity
const offers = await getOffersByEntity(entry);

const pageTitle = entry.data.name || (entityType === 'person' ? 'Person Profile' : 'Organization Profile');
const pageDescription = entry.data.description || `Profile for ${entry.data.name || 'entity'}`;
---

<StarlightPage
	frontmatter={{
		title: pageTitle,
		description: pageDescription,
	}}
	headings={headings}
>
	<article class="entity-page">
		<header class="entity-header">
			{entry.data.image && (
				<img
					src={entry.data.image}
					alt={entry.data.name}
					class="entity-image"
				/>
			)}
		</header>

		<!-- Main Content -->
		<div class="entity-content">
			<Content />
		</div>

		<!-- Relationships -->
		{(memberOf.length > 0 || worksFor.length > 0 || members.length > 0 || parentOrg.length > 0 || offers.length > 0) && (
			<section class="relationships">
				<h2>Relationships</h2>

				{memberOf.length > 0 && (
					<div class="relationship-section">
						<h3>Member Of</h3>
						<ul class="entity-list">
							{memberOf.map((org) => (
								<li>
									{typeof org === 'string' ? (
										<span>{org}</span>
									) : (
										<a href={`/organization/${org.id}`}>{org.data.name}</a>
									)}
								</li>
							))}
						</ul>
					</div>
				)}

				{worksFor.length > 0 && (
					<div class="relationship-section">
						<h3>Works For</h3>
						<ul class="entity-list">
							{worksFor.map((org) => (
								<li>
									{typeof org === 'string' ? (
										<span>{org}</span>
									) : (
										<a href={`/organization/${org.id}`}>{org.data.name}</a>
									)}
								</li>
							))}
						</ul>
					</div>
				)}

				{members.length > 0 && (
					<div class="relationship-section">
						<h3>Members</h3>
						<ul class="entity-list">
							{members.map((member) => (
								<li>
									{typeof member === 'string' ? (
										<span>{member}</span>
									) : (
										<a href={`/${member.collection}/${member.id}`}>
											{member.data.name}
										</a>
									)}
								</li>
							))}
						</ul>
					</div>
				)}

				{parentOrg.length > 0 && (
					<div class="relationship-section">
						<h3>Parent Organization</h3>
						{parentOrg.map((org) => (
							typeof org === 'string' ? (
								<p>{org}</p>
							) : (
								<p><a href={`/organization/${org.id}`}>{org.data.name}</a></p>
							)
						))}
					</div>
				)}

				{offers.length > 0 && (
					<div class="relationship-section">
						<h3>Offers</h3>
						<ul class="entity-list">
							{offers.map((offer) => (
								<li>
									<a href={`/offer/${offer.id}`}>{offer.data.name}</a>
								</li>
							))}
						</ul>
					</div>
				)}
			</section>
		)}

		<!-- Contact & Links -->
		{(entry.data.email || entry.data.url || (entry.data.sameAs && entry.data.sameAs.length > 0)) && (
			<section class="contact-section">
				<h2>Contact & Links</h2>
				<ul class="contact-list">
					{entry.data.email && (
						<li>
							<a href={`mailto:${entry.data.email}`}>{entry.data.email}</a>
						</li>
					)}
					{entry.data.url && (
						<li>
							<a href={entry.data.url} target="_blank" rel="noopener noreferrer">
								Website ↗
							</a>
						</li>
					)}
					{entry.data.sameAs?.map((link) => (
						<li>
							<a href={link} target="_blank" rel="noopener noreferrer">
								{new URL(link).hostname} ↗
							</a>
						</li>
					))}
				</ul>
			</section>
		)}

		<!-- Web3 Identity -->
		{entityType === 'person' && 'ensName' in entry.data && (entry.data.ensName || entry.data.identifier) && (
			<section class="web3-section">
				<h2>Web3 Identity</h2>
				<ul class="web3-list">
					{entry.data.ensName && (
						<li>ENS: {entry.data.ensName}</li>
					)}
					{entry.data.identifier && (
						<li class="identifier">
							<code>{entry.data.identifier}</code>
						</li>
					)}
				</ul>
			</section>
		)}
	</article>
</StarlightPage>

<style>
	.entity-page {
		max-width: 800px;
		margin: 0 auto;
	}

	.entity-header {
		margin-bottom: 2rem;
		text-align: center;
	}

	.entity-image {
		width: 150px;
		height: 150px;
		object-fit: cover;
		border-radius: 8px;
	}

	.entity-content {
		margin-bottom: 3rem;
	}

	.relationships,
	.contact-section,
	.web3-section {
		margin-bottom: 2rem;
		padding: 1.5rem;
		background: var(--sl-color-bg-sidebar);
		border: 1px solid var(--sl-color-gray-5);
		border-radius: 8px;
	}

	.relationships h2,
	.contact-section h2,
	.web3-section h2 {
		font-size: 1.25rem;
		margin-top: 0;
		margin-bottom: 1rem;
		color: var(--sl-color-text-accent);
	}

	.relationship-section {
		margin-bottom: 1.5rem;
	}

	.relationship-section:last-child {
		margin-bottom: 0;
	}

	.relationship-section h3 {
		font-size: 1rem;
		margin-top: 0;
		margin-bottom: 0.5rem;
		color: var(--sl-color-text);
	}

	.relationship-section p {
		color: var(--sl-color-text);
		margin: 0;
	}

	.entity-list,
	.contact-list,
	.web3-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.entity-list li,
	.contact-list li,
	.web3-list li {
		margin-bottom: 0.5rem;
		color: var(--sl-color-text);
	}

	.entity-list li:last-child,
	.contact-list li:last-child,
	.web3-list li:last-child {
		margin-bottom: 0;
	}

	.entity-list a,
	.contact-list a {
		color: var(--sl-color-text-accent);
		text-decoration: none;
	}

	.entity-list a:hover,
	.contact-list a:hover {
		text-decoration: underline;
	}

	.entity-list span {
		color: var(--sl-color-text);
	}

	.identifier code {
		font-size: 0.85rem;
		word-break: break-all;
		background: var(--sl-color-gray-6);
		color: var(--sl-color-text);
		padding: 0.25rem 0.5rem;
		border-radius: 4px;
	}
</style>
