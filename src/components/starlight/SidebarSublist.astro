---
/**
 * Custom SidebarSublist component for Starlight navigation.
 *
 * This component enhances the default Starlight sidebar by:
 * - Making folder labels clickable links to their index pages
 * - Keeping the caret icon separate for expand/collapse functionality
 * - Removing duplicate index page entries from folder children
 *
 * Implementation notes:
 * - Uses inline SVG for caret icon (Starlight's Icon component is not exportable)
 * - Implements flattenSidebar locally (not exported from Starlight)
 * - Detects folder-with-index pattern: first child has same label as group
 */
import type { SidebarEntry, SidebarLink } from '@astrojs/starlight/utils/routing/types';

interface Props {
	sublist: SidebarEntry[];
	nested?: boolean;
}

const { sublist, nested } = Astro.props;

// Flatten nested sidebar structure to a list of links
function flattenSidebar(sidebar: SidebarEntry[]): SidebarLink[] {
	return sidebar.flatMap((entry) =>
		entry.type === 'group' ? flattenSidebar(entry.entries) : entry
	);
}

// Right caret icon SVG (for folder expand/collapse)
const RightCaretIcon = `<svg aria-hidden="true" class="caret" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>`;
---

<ul class:list={{ 'top-level': !nested }}>
	{
		sublist.map((entry, idx) => (
			<li>
				{entry.type === 'link' ? (
					<a
						href={entry.href}
						aria-current={entry.isCurrent && 'page'}
						class:list={[{ large: !nested }, entry.attrs.class]}
						{...entry.attrs}
					>
						<span>{entry.label}</span>
						{entry.badge && (
							<span class="sl-badge" data-variant={entry.badge.variant} data-text={entry.badge.text}>
								{entry.badge.text}
							</span>
						)}
					</a>
				) : (
					<details
						open={flattenSidebar(entry.entries).some((i) => i.isCurrent) || !entry.collapsed}
					>
						<summary>
							{
								// Check if this is a folder with index (first entry has same label as group)
								entry.entries.length > 0 &&
								entry.entries[0].type === 'link' &&
								entry.entries[0].label === entry.label ? (
									// Folder with index: make label clickable
									<>
										<a href={entry.entries[0].href} class="group-label-link">
											<span class="group-label">
												<span class="large">{entry.label}</span>
												{entry.badge && (
													<span class="sl-badge" data-variant={entry.badge.variant} data-text={entry.badge.text}>
														{entry.badge.text}
													</span>
												)}
											</span>
										</a>
										<Fragment set:html={RightCaretIcon} />
									</>
								) : (
									// Regular group: non-clickable label
									<>
										<span class="group-label">
											<span class="large">{entry.label}</span>
											{entry.badge && (
												<span class="sl-badge" data-variant={entry.badge.variant} data-text={entry.badge.text}>
													{entry.badge.text}
												</span>
											)}
										</span>
										<Fragment set:html={RightCaretIcon} />
									</>
								)
							}
						</summary>
						<sl-sidebar-restore data-index={idx.toString()} />
						<Astro.self
							sublist={
								// If first entry is the folder index, skip it to avoid duplication
								entry.entries.length > 0 &&
								entry.entries[0].type === 'link' &&
								entry.entries[0].label === entry.label
									? entry.entries.slice(1)
									: entry.entries
							}
							nested
						/>
					</details>
				)}
			</li>
		))
	}
</ul>

<style>
	@layer starlight.core {
		ul {
			--sl-sidebar-item-padding-inline: 0.5rem;
			list-style: none;
			padding: 0;
		}

		li {
			overflow-wrap: anywhere;
		}

		ul ul li {
			margin-inline-start: var(--sl-sidebar-item-padding-inline);
			border-inline-start: 1px solid var(--sl-color-hairline-light);
			padding-inline-start: var(--sl-sidebar-item-padding-inline);
		}

		.large {
			font-size: var(--sl-text-lg);
			font-weight: 600;
			color: var(--sl-color-white);
		}

		.top-level > li + li {
			margin-top: 0.75rem;
		}

		summary {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0.2em var(--sl-sidebar-item-padding-inline);
			line-height: 1.4;
			cursor: pointer;
			user-select: none;
		}
		summary::marker,
		summary::-webkit-details-marker {
			display: none;
		}

		/* Make the group label link clickable while keeping caret for expand/collapse */
		.group-label-link {
			flex: 1;
			display: block;
			text-decoration: none;
			color: inherit;
			border-radius: 0.25rem;
			margin: -0.2em calc(-1 * var(--sl-sidebar-item-padding-inline));
			padding: 0.2em var(--sl-sidebar-item-padding-inline);
		}

		.group-label-link:hover,
		.group-label-link:focus {
			color: var(--sl-color-white);
			background-color: var(--sl-color-gray-6);
		}

		.caret {
			transition: transform 0.2s ease-in-out;
			flex-shrink: 0;
		}
		:global([dir='rtl']) .caret {
			transform: rotateZ(180deg);
		}
		[open] > summary .caret {
			transform: rotateZ(90deg);
		}

		a {
			display: block;
			border-radius: 0.25rem;
			text-decoration: none;
			color: var(--sl-color-gray-2);
			padding: 0.3em var(--sl-sidebar-item-padding-inline);
			line-height: 1.4;
		}

		a:hover,
		a:focus {
			color: var(--sl-color-white);
		}

		[aria-current='page'],
		[aria-current='page']:hover,
		[aria-current='page']:focus {
			font-weight: 600;
			color: var(--sl-color-text-invert);
			background-color: var(--sl-color-text-accent);
		}

		a > *:not(:last-child),
		.group-label > *:not(:last-child) {
			margin-inline-end: 0.25em;
		}

		/* Badge styling - simplified from Starlight's Badge component */
		.sl-badge {
			display: inline-block;
			border: 1px solid var(--sl-color-gray-5);
			border-radius: 0.25rem;
			font-family: var(--__sl-font-mono);
			font-size: var(--sl-text-xs);
			font-weight: 600;
			line-height: normal;
			padding: 0.125rem 0.375rem;
			text-decoration: none;
			color: var(--sl-color-white);
		}

		@media (min-width: 50rem) {
			.top-level > li + li {
				margin-top: 0.5rem;
			}
			.large {
				font-size: var(--sl-text-base);
			}
			a {
				font-size: var(--sl-text-sm);
			}
		}
	}
</style>
